<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Status Jogadores Sleeper - v.11 - 17/09</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: flex-start;
      background:
        linear-gradient(to right, rgba(244,244,244,0.95) 60%, rgba(244,244,244,0.2) 80%, transparent 100%),
        url('https://i.ibb.co/9mWwdssF/chatgpt-jogadoresquestionaveis.png') no-repeat right center fixed;
      background-size: auto 100%;
      color: #222;
    }
    .content {
      background: rgba(255,255,255,0.92);
      padding: 30px;
      border-radius: 10px;
      max-width: 55%;
      margin: 100px 30px 30px 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    h1 { color: #333; }
    input, button { padding: 8px; font-size: 16px; margin: 5px 0; }
    button { cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
    button:hover { background: #45a049; }
    .team { background: #fff; margin: 20px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .team h2 { margin-top: 0; color: #222; }
    .section { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; }
    .player-card { background: #fafafa; margin: 5px 0; padding: 8px; border-radius: 5px; border: 1px solid #ddd; }
    #darkModeBtn { position: fixed; top: 15px; right: 15px; background: #333; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; z-index: 1000; }
    #darkModeBtn:hover { background: #555; }
    body.dark { background: #121212; color: #f4f4f4; }
    body.dark .content { background: rgba(34,34,34,0.95); box-shadow: none; }
    body.dark .team { background: #1e1e1e; color: #f4f4f4; }
    body.dark .section { background: #2c2c2c; }
    body.dark .player-card { background: #333; border: 1px solid #555; }
    @media (max-width:1024px) { body { background-size: cover; } .content { max-width: 70%; } }
    @media (max-width:768px) {
      body { background: #f4f4f4; display:block; }
      body.dark { background:#121212; }
      .content { max-width:100%; margin:0; border-radius:0; box-shadow:none; background:#fff; }
      body.dark .content { background:#1e1e1e; }
    }
    footer { margin:30px; text-align:center; font-size:14px; color:#555; }
    body.dark footer { color:#aaa; }
  </style>
</head>
<body>
  <button id="darkModeBtn">üåô Dark Mode</button>

  <div class="content">
    <h1>Hora dos Ajustes - Quem t√° ok e Quem t√° fora? (Sleeper)</h1>
    <p>Aquela ajudinha para conferir os jogadores que t√£o fora da rodada no Sleeper Fantasy da NFL.</p>

    <h3>üîé Buscar por League ID</h3>
    <input type="text" id="leagueId" placeholder="Ex: 1234567890"><br>
    <button onclick="buscarPorLiga()">Verificar Liga</button>

    <h3>üîé Buscar por Nome de Usu√°rio</h3>
    <input type="text" id="username" placeholder="Ex: thiagomoura"><br>
    <button onclick="buscarPorUsuario()">Verificar Usu√°rio</button>

    <h3>üîé Validar Franchise Players (League ID + N√∫mero m√≠nimo)</h3>
    <input type="text" id="leagueFranchiseId" placeholder="League ID"><br>
    <input type="number" id="minFranchisePlayers" placeholder="N√∫mero m√≠nimo de Franchise Players"><br>
    <button onclick="buscarFranchisePlayers()">Verificar Franquias</button>

    <div id="resultado"></div>
  </div>

  <footer><p id="contador"></p></footer>

<script>
  // dark mode
  const darkBtn = document.getElementById("darkModeBtn");
  darkBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    darkBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
  });

  // contador simples
  function contadorAcessos() {
    let acessos = localStorage.getItem("acessosSleeper") || 0;
    acessos++;
    localStorage.setItem("acessosSleeper", acessos);
    document.getElementById("contador").innerText = `GMs em a√ß√£o: ${acessos}`;
  }
  contadorAcessos();

  function getStatusColor(status) {
    switch (status) {
      case "Out": return "#e53935";
      case "Questionable": return "#fb8c00";
      case "Doubtful": return "#ef6c00";
      case "IR": return "#8e24aa";
      case "Suspended": return "#616161";
      default: return "#1e88e5";
    }
  }

  // --------------------------
  // BUSCAR POR LEAGUE ID
  // --------------------------
  async function buscarPorLiga() {
    const leagueId = document.getElementById("leagueId").value.trim();
    const resultado = document.getElementById("resultado");
    if (!leagueId) { resultado.innerHTML = "<p style='color:red;'>Informe um League ID.</p>"; return; }
    resultado.innerHTML = "<p>Buscando jogadores...</p>";

    try {
      const usersRes = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/users`);
      const users = await usersRes.json();
      const userMap = {};
      users.forEach(u => {
        userMap[u.user_id] = {
          name: u.display_name,
          teamFromUserMeta: u.metadata?.team_name || null,
          franchiseFromUserMeta: u.metadata?.team_abbreviation || null
        };
      });

      const rostersRes = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/rosters`);
      const rosters = await rostersRes.json();

      const playersRes = await fetch("https://api.sleeper.app/v1/players/nfl");
      const players = await playersRes.json();

      resultado.innerHTML = "";

      // ordenar por nome do time (tenta metadata do roster primeiro)
      rosters.forEach(r => {
        r.displayTeamName = r.metadata?.team_name || userMap[r.owner_id]?.teamFromUserMeta || "Sem nome definido";
      });
      rosters.sort((a,b) => (a.displayTeamName || "").localeCompare((b.displayTeamName || "")));

      rosters.forEach(r => {
        const owner = userMap[r.owner_id] || {};
        const teamName = r.displayTeamName;
        const teamDiv = document.createElement("div");
        teamDiv.className = "team";
        teamDiv.innerHTML = `<h2>${teamName} ‚Äî ${owner.name || "Time sem dono"}</h2>`;

        const startersSection = document.createElement("div");
        startersSection.className = "section";
        startersSection.innerHTML = "<h3>Titulares</h3>";

        let startersCount = 0;
        (r.starters || []).forEach(id => {
          const p = players[id];
          if (p?.injury_status && p.injury_status !== "Healthy") {
            startersCount++;
            const color = getStatusColor(p.injury_status);
            const card = document.createElement("div");
            card.className = "player-card";
            card.innerHTML = `
              <strong>${p.full_name}</strong> (${p.position || "?"}, ${p.team || "FA"})<br>
              Status: <span style="color:${color}; font-weight:bold;">${p.injury_status}</span>
            `;
            startersSection.appendChild(card);
          }
        });

        if (startersCount === 0) {
          startersSection.innerHTML += "<p><em>Nenhum titular com status relevante.</em></p>";
        }

        teamDiv.appendChild(startersSection);
        resultado.appendChild(teamDiv);
      });
    } catch (err) {
      console.error(err);
      resultado.innerHTML = "<p style='color:red;'>Erro ao buscar dados. Verifique o League ID.</p>";
    }
  }

  // --------------------------
  // BUSCAR POR USU√ÅRIO
  // --------------------------
  async function buscarPorUsuario() {
    const username = document.getElementById("username").value.trim();
    const resultado = document.getElementById("resultado");
    if (!username) { resultado.innerHTML = "<p style='color:red;'>Informe um nome de usu√°rio.</p>"; return; }
    resultado.innerHTML = "<p>Buscando ligas do usu√°rio...</p>";

    try {
      const userRes = await fetch(`https://api.sleeper.app/v1/user/${username}`);
      const user = await userRes.json();
      if (!user || !user.user_id) {
        resultado.innerHTML = "<p style='color:red;'>Usu√°rio n√£o encontrado.</p>";
        return;
      }

      const currentYear = new Date().getFullYear();
      const leaguesRes = await fetch(`https://api.sleeper.app/v1/user/${user.user_id}/leagues/nfl/${currentYear}`);
      const leagues = await leaguesRes.json();

      const fantasyLeagues = Array.isArray(leagues) ? leagues.filter(l => l.settings && l.settings.type === 2) : [];

      if (fantasyLeagues.length === 0) {
        resultado.innerHTML = "<p style='color:orange;'>Usu√°rio n√£o participa de ligas de Fantasy NFL Football.</p>";
        return;
      }

      const playersRes = await fetch("https://api.sleeper.app/v1/players/nfl");
      const players = await playersRes.json();

      resultado.innerHTML = "";

      for (const league of fantasyLeagues) {
        try {
          const rostersRes = await fetch(`https://api.sleeper.app/v1/league/${league.league_id}/rosters`);
          const rosters = await rostersRes.json();
          const userRoster = (rosters || []).find(r => r.owner_id === user.user_id);
          if (!userRoster) continue;

          const teamDiv = document.createElement("div");
          teamDiv.className = "team";
          teamDiv.innerHTML = `<h2>${league.name} ‚Äî ${user.display_name}</h2>`;

          const startersSection = document.createElement("div");
          startersSection.className = "section";
          startersSection.innerHTML = "<h3>Titulares</h3>";

          let startersCount = 0;
          (userRoster.starters || []).forEach(id => {
            const p = players[id];
            if (p?.injury_status && p.injury_status !== "Healthy") {
              startersCount++;
              const color = getStatusColor(p.injury_status);
              const card = document.createElement("div");
              card.className = "player-card";
              card.innerHTML = `
                <strong>${p.full_name}</strong> (${p.position || "?"}, ${p.team || "FA"})<br>
                Status: <span style="color:${color}; font-weight:bold;">${p.injury_status}</span>
              `;
              startersSection.appendChild(card);
            }
          });

          if (startersCount === 0) {
            startersSection.innerHTML += "<p><em>Tudo pronto, GM. Agora √© orar, irm√£o.</em></p>";
          }

          teamDiv.appendChild(startersSection);
          resultado.appendChild(teamDiv);
        } catch (errInner) {
          console.warn("Erro ao processar liga:", league.league_id, errInner);
        }
      }
    } catch (err) {
      console.error(err);
      resultado.innerHTML = "<p style='color:red;'>Erro ao buscar dados. Verifique o nome do usu√°rio.</p>";
    }
  }

  // --------------------------
  // BUSCAR FRANCHISE PLAYERS (nova)
  // --------------------------
  async function buscarFranchisePlayers() {
    const leagueId = document.getElementById("leagueFranchiseId").value.trim();
    const minRaw = document.getElementById("minFranchisePlayers").value.trim();
    const resultado = document.getElementById("resultado");

    if (!leagueId) { resultado.innerHTML = "<p style='color:red;'>Informe um League ID.</p>"; return; }
    if (!minRaw || isNaN(Number(minRaw))) {
      resultado.innerHTML = "<p style='color:red;'>Informe um n√∫mero v√°lido para 'N√∫mero m√≠nimo de Franchise Players'.</p>";
      return;
    }
    const minFranchise = parseInt(minRaw, 10);

    resultado.innerHTML = "<p>Verificando franquias...</p>";

    try {
      // usu√°rios e mapeamentos
      const usersRes = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/users`);
      const users = await usersRes.json();
      const userMap = {};
      users.forEach(u => {
        userMap[u.user_id] = {
          name: u.display_name,
          teamFromUserMeta: u.metadata?.team_name || null,
          franchiseFromUserMeta: (u.metadata?.team_abbreviation || u.metadata?.team_name || null)
        };
      });

      // rosters
      const rostersRes = await fetch(`https://api.sleeper.app/v1/league/${leagueId}/rosters`);
      const rosters = await rostersRes.json();

      // jogadores
      const playersRes = await fetch("https://api.sleeper.app/v1/players/nfl");
      const players = await playersRes.json();

      resultado.innerHTML = "";

      // fun√ß√£o utilit√°ria para checar se jogador pertence √† franquia (heur√≠stica)
      function playerBelongsToFranchise(p, franchiseNormalized) {
        if (!p || !p.team || !franchiseNormalized) return false;
        const pTeam = (p.team || "").toUpperCase();
        const f = franchiseNormalized.toUpperCase();
        if (pTeam === f) return true;
        // checar se abrevia√ß√£o est√° contida ou vice-versa
        if (pTeam.includes(f) || f.includes(pTeam)) return true;
        return false;
      }

      // processa cada roster
      // ordenar rosters por nome do time (metadata ou user meta)
      (rosters || []).forEach(r => {
        r.displayTeamName = r.metadata?.team_name || userMap[r.owner_id]?.teamFromUserMeta || "Sem nome definido";
      });
      rosters.sort((a,b) => (a.displayTeamName || "").localeCompare((b.displayTeamName || "")));

      rosters.forEach(r => {
        const owner = userMap[r.owner_id] || {};
        // tenta obter franquia em diferentes fontes:
        const rawFranchise = (r.metadata?.team_abbreviation) || (r.metadata?.team_name) || owner.franchiseFromUserMeta || owner.teamFromUserMeta || "";
        const franchiseNormalized = rawFranchise ? String(rawFranchise).toUpperCase().trim() : "";

        // n√£o abortar se franquia ausente; apenas mostrar aviso
        let totalFranchiseStarters = 0;
        let healthyFranchiseStarters = 0;
        const franchisePlayersList = [];

        (r.starters || []).forEach(id => {
          const p = players[id];
          if (!p) return; // pula se dados do jogador n√£o existirem
          if (franchiseNormalized && playerBelongsToFranchise(p, franchiseNormalized)) {
            totalFranchiseStarters++;
            const isHealthy = !p.injury_status || p.injury_status === "Healthy";
            if (isHealthy) healthyFranchiseStarters++;
            franchisePlayersList.push({
              name: p.full_name,
              position: p.position || "",
              team: p.team || "",
              status: p.injury_status || "Healthy",
              healthy: isHealthy
            });
          }
        });

        // monta bloco do time
        const teamDiv = document.createElement("div");
        teamDiv.className = "team";
        const teamLabel = r.displayTeamName;
        const ownerLabel = owner.name || "Time sem dono";
        teamDiv.innerHTML = `<h2>${teamLabel} ‚Äî ${ownerLabel}</h2>`;

        const section = document.createElement("div");
        section.className = "section";

        // mostra franquia identificada (ou alerta se n√£o identificada)
        if (franchiseNormalized) {
          section.innerHTML = `
            <p>Franquia identificada: <strong>${franchiseNormalized}</strong></p>
            <p>Jogadores titulares da franquia escalados: <strong>${totalFranchiseStarters}</strong></p>
            <p>Dos quais saud√°veis: <strong>${healthyFranchiseStarters}</strong></p>
          `;
        } else {
          section.innerHTML = `
            <p style="color:orange;"><strong>Franquia n√£o identificada automaticamente.</strong></p>
            <p>Jogadores titulares da franquia escalados (n√£o identificados): <strong>${totalFranchiseStarters}</strong></p>
            <p>Dos quais saud√°veis: <strong>${healthyFranchiseStarters}</strong></p>
            <p>Observa√ß√£o: verifique se o campo "team_abbreviation" ou "team_name" est√° preenchido em roster.metadata ou no perfil do usu√°rio.</p>
          `;
        }

        // valida m√≠nimo
        if (healthyFranchiseStarters >= minFranchise) {
          section.innerHTML += `<p style="color:green; font-weight:bold;">‚úÖ Bom trabalho, tudo ok com a Franquia.</p>`;
        } else {
          const faltam = minFranchise - healthyFranchiseStarters;
          section.innerHTML += `<p style="color:red; font-weight:bold;">‚ö†Ô∏è Franquia em Risco ‚Äî Faltam <strong style="color:red;">${faltam}</strong></p>`;

          if (franchisePlayersList.length > 0) {
            section.innerHTML += "<h4>Jogadores titulares da franquia (lista):</h4>";
            franchisePlayersList.forEach(p => {
              section.innerHTML += `<div class="player-card">${p.name} (${p.position}, ${p.team}) ‚Äî ${p.status}</div>`;
            });
          } else {
            section.innerHTML += "<p><em>Nenhum jogador da franquia foi identificado entre os titulares.</em></p>";
          }
        }

        teamDiv.appendChild(section);
        resultado.appendChild(teamDiv);
      });

    } catch (err) {
      console.error(err);
      resultado.innerHTML = "<p style='color:red;'>Erro ao buscar dados. Verifique os par√¢metros e o League ID.</p>";
    }
  }
</script>
</body>
</html>
