<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Awaken - v20 | 17SET25</title>
  <style>
    :root{
      --accent:#1e90ff; --ok:#2e7d32; --bad:#b71c1c; --muted:#777; --card:#fff;
    }
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;}
    body {
      background:
        linear-gradient(to right, rgba(244,244,244,0.97) 60%, rgba(244,244,244,0.85) 80%, transparent 100%),
        url('https://i.ibb.co/9mWwdssF/chatgpt-jogadoresquestionaveis.png') no-repeat right center fixed;
      background-size: auto 100%;
      color:#222;
    }
    body.dark{
      background:
        linear-gradient(to right, rgba(12,12,12,1) 60%, rgba(12,12,12,0.9) 80%, transparent 100%),
        url('https://i.ibb.co/9mWwdssF/chatgpt-jogadoresquestionaveis.png') no-repeat right center fixed;
      background-size:auto 100%;
      color:#eaeaea;
    }

    .page{max-width:1000px;margin:48px 24px 120px 48px;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
    .brand{display:flex;gap:12px;align-items:center;}
    img.logo{height:44px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
    h1{font-size:18px;margin:0;}
    .dark-toggle{position:fixed;top:16px;right:18px;z-index:1200;background:#111;color:#fff;border:0;padding:8px 12px;border-radius:20px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);}
    body.dark .dark-toggle{background:#ddd;color:#111;}

    .controls{display:grid;grid-template-columns:1fr;gap:18px;margin-bottom:16px;}
    .panel{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
    body.dark .panel{background:#111;color:#eaeaea;box-shadow:none;}
    .panel h3{margin:0 0 8px 0;font-size:16px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    input[type="text"], input[type="number"]{padding:8px 10px;border-radius:8px;border:1px solid #ddd;min-width:180px;}
    body.dark input{background:#1b1b1b;border:1px solid #333;color:#eaeaea;}
    button.primary{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;}
    button.ghost{background:transparent;border:1px solid #ccc;padding:7px 10px;border-radius:8px;color:inherit;cursor:pointer;}

    #resultado{margin-top:18px;}
    .controls-actions { display:flex; gap:12px; align-items:center; margin-top:8px; }

    /* Team card (accordion) */
    .team-card{border-radius:10px;overflow:hidden;margin-bottom:12px;background:var(--card);color:inherit;border:1px solid rgba(0,0,0,0.06);}
    body.dark .team-card{background:#111;border:1px solid rgba(255,255,255,0.03);}
    .team-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;cursor:pointer;}
    .team-left{display:flex;gap:12px;align-items:center;}
    .team-title{font-weight:700;}
    .team-meta{color:var(--muted);font-size:13px;}
    .team-stats{display:flex;gap:8px;align-items:center;}
    .badge{background:var(--accent);color:#fff;padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700;}
    .badge.bad{background:var(--bad);}
    .badge.ok{background:var(--ok);}
    .team-body{padding:12px 14px;border-top:1px solid rgba(0,0,0,0.04);display:none;}
    body.dark .team-body{border-top:1px solid rgba(255,255,255,0.03);}

    .player-card{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin:8px 0;box-shadow:0 6px 14px rgba(0,0,0,0.06);background:#fff;}
    body.dark .player-card{background:#161616;box-shadow:none;}
    .player-left{display:flex;gap:12px;align-items:center;}
    .player-name{font-weight:700;}
    .player-pos{color:var(--muted);font-size:13px;}
    .status-pill{padding:6px 10px;border-radius:999px;color:#fff;font-weight:700;font-size:13px;}
    .status-Out{background:#b71c1c;}
    .status-Questionable,.status-Doubtful{background:#ef6c00;}
    .status-IR{background:#6a1b9a;}
    .status-Suspended{background:#424242;}
    .status-Healthy{background:#2e7d32;}

    .summary{margin-top:8px;font-weight:700;}

    footer{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,0.98);color:#333;padding:10px 18px;box-shadow:0 -6px 30px rgba(0,0,0,0.08);display:flex;justify-content:center;gap:18px;align-items:center;font-size:14px;}
    body.dark footer{background:rgba(10,10,10,0.98);color:#ddd;}
    footer a{color:var(--accent);text-decoration:none;font-weight:700;}
    footer a:hover{text-decoration:underline;}

    @media(max-width:900px){.page{margin:20px;}footer{font-size:13px;padding:10px;}}
  </style>
</head>
<body>
  <button class="dark-toggle" id="darkToggle">🌙 Dark Mode</button>

  <div class="page">
    <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <div style="display:flex;gap:12px;align-items:center;">
       <!-- <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/a/a2/National_Football_League_logo.svg" alt="NFL logo"/> -->
        <div>
          <h1>Awaken</h1>
          <div style="color:var(--muted);font-size:13px">Revisando jogadores lesionados e ligas com regras de franchise players.</div>
        </div>
      </div>
      <div>
        <button class="ghost" id="expandAllBtn">Expandir todos</button>
        <button class="ghost" id="collapseAllBtn">Recolher todos</button>
      </div>
    </header>

    <div class="controls">
      <!-- 1 -->
      <div class="panel">
        <h3>1) Buscar por League ID</h3>
        <div class="row">
          <input id="leagueId" type="text" placeholder="League ID (Ex: 1234567890)">
          <button class="primary" onclick="buscarPorLiga()">Buscar Liga</button>
        </div>
        <div style="color:var(--muted);font-size:13px;margin-top:8px;">Mostra titulares com status diferente de "Healthy" por time.</div>
      </div>

      <!-- 2 -->
      <div class="panel">
        <h3>2) Buscar por Usuário (username)</h3>
        <div class="row">
          <input id="username" type="text" placeholder="Usuário Sleeper">
          <button class="primary" onclick="buscarPorUsuario()">Buscar Usuário</button>
        </div>
        <div style="color:var(--muted);font-size:13px;margin-top:8px;">Procura em ligas NFL fantasy do usuário.</div>
      </div>

      <!-- 3 -->
      <div class="panel">
        <h3>3) Verificar Franchise Players</h3>
        <div class="row">
          <input id="franchiseLeagueId" type="text" placeholder="League ID">
          <input id="minFranchise" type="number" placeholder="Mínimo titulares" style="width:150px;">
          <button class="primary" onclick="buscarFranchisePlayers()">Verificar Franquias</button>
          <button class="ghost" onclick="exportWhatsAppSummary()">Exportar (WhatsApp)</button>
        </div>
        <div style="color:var(--muted);font-size:13px;margin-top:8px;">Para cada time mostra titulares, franquia detectada (editável), contadores.</div>
      </div>
    </div>

    <div id="resultado"></div>
  </div>

  <footer>
    <div id="accessCount">GMs em ação: 0</div>
    <div><a href="mailto:scrum.moura@gmail.com">Algo de errado? Novas ideias? Fale conosco.</a></div>
  </footer>

<script>
/* ---------- Data: 32 teams + abbr map ---------- */
const nflTeams = [
  "Arizona Cardinals","Atlanta Falcons","Baltimore Ravens","Buffalo Bills",
  "Carolina Panthers","Chicago Bears","Cincinnati Bengals","Cleveland Browns",
  "Dallas Cowboys","Denver Broncos","Detroit Lions","Green Bay Packers",
  "Houston Texans","Indianapolis Colts","Jacksonville Jaguars","Kansas City Chiefs",
  "Las Vegas Raiders","Los Angeles Chargers","Los Angeles Rams","Miami Dolphins",
  "Minnesota Vikings","New England Patriots","New Orleans Saints","New York Giants",
  "New York Jets","Philadelphia Eagles","Pittsburgh Steelers","San Francisco 49ers",
  "Seattle Seahawks","Tampa Bay Buccaneers","Tennessee Titans","Washington Commanders"
];
const abbrToFull = {
  ARI:"Arizona Cardinals",ATL:"Atlanta Falcons",BAL:"Baltimore Ravens",BUF:"Buffalo Bills",
  CAR:"Carolina Panthers",CHI:"Chicago Bears",CIN:"Cincinnati Bengals",CLE:"Cleveland Browns",
  DAL:"Dallas Cowboys",DEN:"Denver Broncos",DET:"Detroit Lions",GB:"Green Bay Packers",
  HOU:"Houston Texans",IND:"Indianapolis Colts",JAX:"Jacksonville Jaguars",KC:"Kansas City Chiefs",
  LV:"Las Vegas Raiders",LAC:"Los Angeles Chargers",LAR:"Los Angeles Rams",MIA:"Miami Dolphins",
  MIN:"Minnesota Vikings",NE:"New England Patriots",NO:"New Orleans Saints",NYG:"New York Giants",
  NYJ:"New York Jets",PHI:"Philadelphia Eagles",PIT:"Pittsburgh Steelers",SF:"San Francisco 49ers",
  SEA:"Seattle Seahawks",TB:"Tampa Bay Buccaneers",TEN:"Tennessee Titans",WSH:"Washington Commanders",
  WAS:"Washington Commanders"
};

/* ---------- Helpers ---------- */
function normalizeName(s){ if(!s) return ""; return String(s).toLowerCase().replace(/[^a-z0-9]/g,""); }
function matchTeamByName(name){
  if(!name) return "";
  const n = normalizeName(name);
  for(const t of nflTeams){
    if(normalizeName(t).includes(n) || n.includes(normalizeName(t))) return t;
  }
  // try word parts
  const parts = name.split(/\s+/).map(p=>normalizeName(p)).filter(Boolean);
  for(const t of nflTeams){
    const tn = normalizeName(t);
    if(parts.every(p => tn.includes(p) || p.includes(tn))) return t;
  }
  return "";
}
function abbrToFullName(abbr){ if(!abbr) return ""; const up = String(abbr).toUpperCase(); return abbrToFull[up] || ""; }
function statusClass(status){
  if(!status) return "status-Healthy";
  if(status==="Out") return "status-Out";
  if(status==="Questionable"||status==="Doubtful") return "status-Questionable";
  if(status==="IR") return "status-IR";
  if(status==="Suspended") return "status-Suspended";
  return "status-Healthy";
}
function getColorForStatus(status){
  switch(status){
    case "Out": return "#b71c1c";
    case "Questionable": case "Doubtful": return "#ef6c00";
    case "IR": return "#6a1b9a";
    case "Suspended": return "#424242";
    default: return "#2e7d32";
  }
}
async function safeFetchJson(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

/* Dark toggle */
document.getElementById("darkToggle").addEventListener("click", ()=>{
  document.body.classList.toggle("dark");
  document.getElementById("darkToggle").textContent = document.body.classList.contains("dark") ? "☀️ Light Mode" : "🌙 Dark Mode";
});

/* Access counter */
(function(){
  let n = Number(localStorage.getItem("acessosSleeper")||0);
  n++; localStorage.setItem("acessosSleeper", n);
  document.getElementById("accessCount").textContent = `GMs em ação: ${n}`;
})();

/* Expand/Collapse all */
document.getElementById("expandAllBtn").addEventListener("click", ()=>{
  document.querySelectorAll(".team-body").forEach(b=>b.style.display="block");
});
document.getElementById("collapseAllBtn").addEventListener("click", ()=>{
  document.querySelectorAll(".team-body").forEach(b=>b.style.display="none");
});

/* ---------- 1) League ID ---------- */
async function buscarPorLiga(){
  const leagueId = document.getElementById("leagueId").value.trim();
  const out = document.getElementById("resultado");
  out.innerHTML = `<div class="panel">Buscando liga ${leagueId}…</div>`;
  if(!leagueId){ out.innerHTML = `<div class="panel" style="color:#b71c1c">Informe um League ID.</div>`; return; }

  try{
    const [users, rosters, playersObj] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/users`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/rosters`),
      safeFetchJson("https://api.sleeper.app/v1/players/nfl")
    ]);
    const players = playersObj || {};
    const userMap = {};
    (users||[]).forEach(u => userMap[u.user_id] = { name:u.display_name || "Time sem dono", userTeamMeta: u.metadata?.team_name || "" });

    // build array of rosters with detected name for sorting
    const enriched = (rosters||[]).map(r=>{
      const owner = userMap[r.owner_id] || {name:"Time sem dono", userTeamMeta:""};
      const raw = r.metadata?.team_name || owner.userTeamMeta || owner.name || "";
      const detected = matchTeamByName(raw) || raw || owner.name || "";
      return { roster:r, owner, raw, detected };
    });

    enriched.sort((a,b) => (a.detected||"").localeCompare(b.detected||""));

    out.innerHTML = "";
    for(const item of enriched){
      const r = item.roster;
      const owner = item.owner;
      const detected = item.detected;
      // count injured starters and collect players
      const starters = (r.starters||[]).map(id => players[id]).filter(Boolean);
      const injuredPlayers = starters.filter(p => p.injury_status && p.injury_status !== "Healthy");
      // build card
      const card = document.createElement("div"); card.className="team-card";
      const header = document.createElement("div"); header.className="team-header";
      header.innerHTML = `
        <div class="team-left">
          <div>
            <div class="team-title">${detected} — ${owner.name}</div>
            <div class="team-meta">${r.metadata?.team_name ? `meta: ${r.metadata.team_name}` : 'sem metadata'}</div>
          </div>
        </div>
        <div class="team-stats">
          <div class="badge ${injuredPlayers.length>0? 'bad' : 'ok'}">${injuredPlayers.length} lesionados</div>
        </div>
      `;
      header.addEventListener("click", ()=> toggleBody(card));
      const body = document.createElement("div"); body.className="team-body";
      // if injured present, open automatically
      if(injuredPlayers.length>0) body.style.display="block";

      if(injuredPlayers.length===0){
        body.innerHTML = `<div class="summary">Nenhum titular com status diferente de Healthy.</div>`;
      } else {
        for(const p of injuredPlayers){
          const pl = document.createElement("div"); pl.className="player-card";
          pl.innerHTML = `
            <div class="player-left">
              <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
              <div>
                <div class="player-name">${p.full_name}</div>
                <div class="player-pos">${p.position || "?"} — ${p.team || "FA"}</div>
              </div>
            </div>
            <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status || "Healthy"}</div></div>
          `;
          body.appendChild(pl);
        }
      }

      card.appendChild(header); card.appendChild(body);
      out.appendChild(card);
    }

  } catch(err){
    console.error(err);
    out.innerHTML = `<div class="panel" style="color:#b71c1c">Erro ao buscar a liga. Verifique o League ID.</div>`;
  }
}

/* toggle helper */
function toggleBody(card){
  const body = card.querySelector(".team-body");
  if(!body) return;
  body.style.display = body.style.display === "block" ? "none" : "block";
}

/* ---------- 2) Buscar por Usuário ---------- */
async function buscarPorUsuario(){
  const username = document.getElementById("username").value.trim();
  const out = document.getElementById("resultado");
  out.innerHTML = `<div class="panel">Buscando usuário ${username} …</div>`;
  if(!username){ out.innerHTML = `<div class="panel" style="color:#b71c1c">Informe um nome de usuário.</div>`; return; }

  try{
    const userData = await safeFetchJson(`https://api.sleeper.app/v1/user/${username}`);
    if(!userData || !userData.user_id){ out.innerHTML = `<div class="panel" style="color:#b71c1c">Usuário não encontrado.</div>`; return; }
    const [leagues, playersObj] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/user/${userData.user_id}/leagues/nfl/${new Date().getFullYear()}`),
      safeFetchJson("https://api.sleeper.app/v1/players/nfl")
    ]);
    const players = playersObj || {};
    out.innerHTML = "";

    const fantasyLeagues = (leagues||[]).filter(l => l.settings && l.settings.type === 2);
    for(const league of fantasyLeagues){
      try{
        const rosters = await safeFetchJson(`https://api.sleeper.app/v1/league/${league.league_id}/rosters`);
        // identify roster for this user
        const roster = (rosters||[]).find(r => r.owner_id === userData.user_id);
        if(!roster) continue;
        const teamRaw = roster.metadata?.team_name || league.name || "";
        const detected = matchTeamByName(teamRaw) || teamRaw || league.name;
        const starters = (roster.starters||[]).map(id => players[id]).filter(Boolean);
        const injuredPlayers = starters.filter(p => p.injury_status && p.injury_status !== "Healthy");

        // create card
        const card = document.createElement("div"); card.className="team-card";
        const header = document.createElement("div"); header.className="team-header";
        header.innerHTML = `
          <div class="team-left">
            <div>
              <div class="team-title">${detected} — ${userData.display_name}</div>
              <div class="team-meta">${league.name}</div>
            </div>
          </div>
          <div class="team-stats">
            <div class="badge ${injuredPlayers.length>0?'bad':'ok'}">${injuredPlayers.length} lesionados</div>
          </div>
        `;
        header.addEventListener("click", ()=> toggleBody(card));
        const body = document.createElement("div"); body.className="team-body";
        if(injuredPlayers.length>0) body.style.display="block";

        if(injuredPlayers.length===0){
          body.innerHTML = `<div class="summary">Nenhum titular com status diferente de Healthy nesta liga.</div>`;
        } else {
          for(const p of injuredPlayers){
            const pl = document.createElement("div"); pl.className="player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} — ${p.team || "FA"}</div>
                </div>
              </div>
              <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status}</div></div>
            `;
            body.appendChild(pl);
          }
        }

        card.appendChild(header); card.appendChild(body); out.appendChild(card);

      } catch(errInner){
        console.warn("Erro liga", league.league_id, errInner);
      }
    }

  } catch(err){
    console.error(err);
    out.innerHTML = `<div class="panel" style="color:#b71c1c">Erro ao buscar usuário.</div>`;
  }
}

/* ---------- 3) Franchise Players ---------- */
async function buscarFranchisePlayers(){
  const leagueId = document.getElementById("franchiseLeagueId").value.trim();
  const minFrRaw = document.getElementById("minFranchise").value.trim();
  const out = document.getElementById("resultado");
  out.innerHTML = `<div class="panel">Buscando franquias na liga ${leagueId} …</div>`;
  if(!leagueId || !minFrRaw){ out.innerHTML = `<div class="panel" style="color:#b71c1c">Informe League ID e mínimo de titulares.</div>`; return; }
  const minFr = parseInt(minFrRaw,10);

  try{
    const [users, rosters, playersObj] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/users`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/rosters`),
      safeFetchJson("https://api.sleeper.app/v1/players/nfl")
    ]);
    const players = playersObj || {};
    const userMap = {};
    (users||[]).forEach(u => userMap[u.user_id] = { name:u.display_name || "Time sem dono", userTeamMeta:u.metadata?.team_name || "" });

    // enrich rosters with detected team name for sorting
    const enriched = (rosters||[]).map(r=>{
      const owner = userMap[r.owner_id] || {name:"Time sem dono", userTeamMeta:""};
      const raw = r.metadata?.team_name || owner.userTeamMeta || owner.name || "";
      const detected = matchTeamByName(raw) || raw || owner.name || "";
      return { roster:r, owner, raw, detected };
    });
    enriched.sort((a,b) => (a.detected||"").localeCompare(b.detected||""));

    out.innerHTML = "";
    // we will also build a summary list for export
    window._exportSummary = []; // reset

    for(const item of enriched){
      const r = item.roster;
      const owner = item.owner;
      const detectedAuto = item.detected;
      const starters = (r.starters||[]).map(id => players[id]).filter(Boolean);

      // compute injured overall among starters (to auto-open)
      const injuredOverall = starters.filter(p => p.injury_status && p.injury_status !== "Healthy").length;

      // derive franchise detection:
      let franchiseCanonical = detectedAuto || "";
      // if still not canonical, try best from starters by majority of p.team (abbr->full)
      if(!franchiseCanonical || franchiseCanonical==="Franquia sem nome"){
        const counts = {};
        for(const p of starters){
          if(!p || !p.team) continue;
          counts[p.team] = (counts[p.team]||0)+1;
        }
        let bestAbbr = "", bestCount=0;
        for(const k in counts){ if(counts[k] > bestCount){ bestAbbr=k; bestCount=counts[k]; } }
        if(bestAbbr){
          const full = abbrToFull[bestAbbr] || bestAbbr;
          franchiseCanonical = full;
        }
      }
      if(!franchiseCanonical) franchiseCanonical = item.raw || owner.name || "Franquia sem nome";

      // Build card
      const card = document.createElement("div"); card.className="team-card";
      const header = document.createElement("div"); header.className="team-header";
      header.innerHTML = `
        <div class="team-left">
          <div>
            <div class="team-title">${franchiseCanonical} — ${owner.name}</div>
            <div class="team-meta">${item.raw ? `meta: ${item.raw}` : 'sem metadata'}</div>
          </div>
        </div>
        <div class="team-stats">
          <div class="badge" style="background:#ff9800;">Franchise: <span class="franchise-count">0</span></div>
          <div class="badge ${injuredOverall>0?'bad':'ok'}" style="margin-left:8px;"><span class="inj-count">${injuredOverall}</span> lesionados</div>
        </div>
      `;
      header.addEventListener("click", ()=> toggleBody(card));

      const body = document.createElement("div"); body.className="team-body";
      if(injuredOverall>0) body.style.display="block"; // auto-open teams with injured

      // editable franchise input (in body)
      const row = document.createElement("div");
      row.style.marginBottom = "8px";
      row.innerHTML = `
        <label style="font-weight:700;margin-right:8px;">Nome da Franquia (edite se necessário):</label>
        <input type="text" class="team-input" value="${franchiseCanonical}" style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;width:60%;">
      `;
      body.appendChild(row);

      // area for summary & players; will be rebuilt on input change
      const containerPlayers = document.createElement("div");
      containerPlayers.className = "players-list-area";
      body.appendChild(containerPlayers);

      // recompute function
      function recompute(){
        containerPlayers.innerHTML = "";
        const franchiseVal = (body.querySelector(".team-input").value||"").trim();
        // canonicalize if abbr
        let franchiseFull = franchiseVal;
        if(franchiseVal && franchiseVal.length<=3){
          const mapped = abbrToFull[franchiseVal.toUpperCase()];
          if(mapped) franchiseFull = mapped;
        } else {
          const matched = matchTeamByName(franchiseVal);
          if(matched) franchiseFull = matched;
        }

        // determine franchiseStarters: starters whose p.team -> full name matches franchiseFull
        const franchiseStarters = [];
        for(const p of starters){
          const pFull = abbrToFull[p.team] || abbrToFullName(p.team) || "";
          // compare normalized
          if(franchiseFull && (normalizeName(pFull)===normalizeName(franchiseFull) || normalizeName(p.team||"")===normalizeName(franchiseFull) || normalizeName(pFull).includes(normalizeName(franchiseFull)) || normalizeName(franchiseFull).includes(normalizeName(pFull)))){
            franchiseStarters.push(p);
          }
        }

        // healthy among franchiseStarters
        const healthyFranchise = franchiseStarters.filter(p => !p.injury_status || p.injury_status==="Healthy").length;

        // Update badges
        const badgeFr = card.querySelector(".franchise-count");
        if(badgeFr) badgeFr.textContent = franchiseStarters.length;
        const badgeInj = card.querySelector(".inj-count");
        if(badgeInj) badgeInj.textContent = starters.filter(p=>p.injury_status && p.injury_status!=="Healthy").length;

        // summary
        const summary = document.createElement("div");
        summary.className = "summary";
        summary.innerHTML = `Titulares da franquia identificados: <strong>${franchiseStarters.length}</strong> — Saudáveis: <strong>${healthyFranchise}</strong> (mínimo: <strong>${minFr}</strong>)`;
        containerPlayers.appendChild(summary);

        // risk/ok line
        const statusLine = document.createElement("div");
        if(healthyFranchise >= minFr){
          statusLine.innerHTML = `<div style="color:var(--ok);font-weight:800;margin-top:6px;">✅ Bom trabalho — franquia atende o mínimo.</div>`;
        } else {
          const falta = minFr - healthyFranchise;
          statusLine.innerHTML = `<div style="color:var(--bad);font-weight:800;margin-top:6px;">⚠️ Franquia em Risco — faltam <strong>${falta}</strong> titulares saudáveis.</div>`;
        }
        containerPlayers.appendChild(statusLine);

        // Show ALL starters who have status != Healthy (even if not from franchise)
        const nonHealthyStarters = starters.filter(p => p.injury_status && p.injury_status !== "Healthy");
        if(nonHealthyStarters.length>0){
          const title = document.createElement("div"); title.style.marginTop="10px"; title.style.fontWeight="700"; title.textContent = "Titulares com status diferente de Healthy (todos):";
          containerPlayers.appendChild(title);
          for(const p of nonHealthyStarters){
            const pl = document.createElement("div"); pl.className="player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} — ${p.team || ""}</div>
                </div>
              </div>
              <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status || "Healthy"}</div></div>
            `;
            containerPlayers.appendChild(pl);
          }
        } else {
          const none = document.createElement("div"); none.style.marginTop="8px"; none.textContent = "Nenhum titular com status diferente de Healthy.";
          containerPlayers.appendChild(none);
        }

        // Also list franchiseStarters specifically (if any) with highlight
        if(franchiseStarters.length>0){
          const t = document.createElement("div"); t.style.marginTop="10px"; t.style.fontWeight="700"; t.textContent = "Titulares pertencentes à franquia:";
          containerPlayers.appendChild(t);
          for(const p of franchiseStarters){
            const pl = document.createElement("div"); pl.className="player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} — ${p.team || ""}</div>
                </div>
              </div>
              <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status || "Healthy"}</div></div>
            `;
            containerPlayers.appendChild(pl);
          }
        }

        // prepare export summary flag: if risk or injured add to window._exportSummary
        const healthyFr = healthyFranchise;
        const injuredCnt = starters.filter(p=>p.injury_status && p.injury_status!=="Healthy").length;
        if(injuredCnt>0 || healthyFr < minFr){
          window._exportSummary.push({
            team: franchiseFull || franchiseVal || franchiseCanonical,
            owner: owner.name,
            injured: injuredCnt,
            franchiseStarters: franchiseStarters.map(p=>p.full_name),
            healthyFranchise: healthyFr,
            minFr: minFr
          });
        }
      }

      // initial render and wiring
      recompute();
      const inputEl = row.querySelector(".team-input");
      inputEl.addEventListener("change", recompute);
      inputEl.addEventListener("keyup", (e)=>{ if(e.key==="Enter") recompute(); });

      // header badges initial
      const badgeWrap = card.querySelector(".team-stats");
      // clear existing and add consistent badges
      header.querySelector(".team-stats").innerHTML = `<div class="badge"><span class="franchise-count">0</span> franchise</div><div class="badge" style="margin-left:8px;"><span class="inj-count">${injuredOverall}</span> lesionados</div>`;

      card.appendChild(header); card.appendChild(body);
      out.appendChild(card);
    }

    // After building everything, if some cards have injured, they are already open due to recompute()
  } catch(err){
    console.error(err);
    out.innerHTML = `<div class="panel" style="color:#b71c1c">Erro ao buscar franquias. Verifique parâmetros e League ID.</div>`;
  }
}

/* ---------- Export WhatsApp summary ---------- */
async function exportWhatsAppSummary(){
  // window._exportSummary built during last franchise search
  const arr = window._exportSummary || [];
  if(!arr.length){
    alert("Nenhum problema detectado para exportar. Execute a verificação de franquias primeiro.");
    return;
  }
  // Build text
  let text = "Resumo - Times com problemas (automático):\n";
  arr.forEach(t=>{
    text += `\n${t.team} — GM: ${t.owner}\nLesionados: ${t.injured}\nFranchise titulares saudáveis: ${t.healthyFranchise}/${t.minFr}\nTitulares da franquia: ${t.franchiseStarters.length ? t.franchiseStarters.join(", ") : "Nenhum"}\n`;
  });
  // copy to clipboard
  try{
    await navigator.clipboard.writeText(text);
    const open = confirm("Resumo copiado para área de transferência. Deseja abrir o WhatsApp Web com a mensagem já preenchida?");
    if(open){
      const url = "https://web.whatsapp.com/send?text=" + encodeURIComponent(text);
      window.open(url, "_blank");
    } else {
      alert("Resumo copiado. Cole no WhatsApp (ou onde preferir).");
    }
  } catch(e){
    console.error(e);
    alert("Não consegui copiar automaticamente. Aqui está o texto:\n\n" + text);
  }
}
</script>
</body>
</html>
