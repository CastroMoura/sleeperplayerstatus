<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Awaken - v26 - 18SET25</title>
  <style>
    :root{
      --bg-left-dark: linear-gradient(90deg, rgba(10,10,10,1) 0%, rgba(40,40,40,0.9) 60%);
      --card-bg: #ffffff;
      --card-text: #222;
      --accent: #1e90ff;
      --ok: #2e7d32;
      --bad: #b71c1c;
      --orange: #ef6c00;
      --muted: #777;
    }
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;}
    body{
      background:
        linear-gradient(to right, rgba(244,244,244,0.97) 60%, rgba(244,244,244,0.85) 80%, transparent 100%),
        url('https://i.ibb.co/9mWwdssF/chatgpt-jogadoresquestionaveis.png') no-repeat right center fixed;
      background-size: auto 100%;
      color:var(--card-text);
    }

    /* Dark */
    body.dark{
      background:
        linear-gradient(to right, rgba(12,12,12,1) 60%, rgba(12,12,12,0.9) 80%, transparent 100%),
        url('https://i.ibb.co/9mWwdssF/chatgpt-jogadoresquestionaveis.png') no-repeat right center fixed;
      background-size:auto 100%;
      color:#eaeaea;
    }

    /* Page container */
    .page {
      max-width:1000px;
      margin:48px 24px 120px 48px;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    header .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }
    header img.logo{
      height:44px;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }
    header h1{
      font-size:18px;margin:0;color:inherit;
    }

    /* Dark toggle */
    .dark-toggle {
      position:fixed;
      top:16px;
      right:18px;
      z-index:1200;
      background:#111;color:#fff;border:0;padding:8px 12px;border-radius:20px;cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    }
    body.dark .dark-toggle{ background:#ddd;color:#111; }

    .controls {
      display:grid;
      grid-template-columns:1fr;
      gap:18px;
      margin-bottom:12px;
    }

    .panel {
      background:var(--card-bg);
      color:var(--card-text);
      border-radius:10px;
      padding:14px;
      box-shadow:0 6px 20px rgba(0,0,0,0.08);
    }
    body.dark .panel {
      background:#111; color:#eaeaea; box-shadow: none;
    }

    .panel h3 { margin:0 0 8px 0; font-size:16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    input[type="text"], input[type="number"], select {
      padding:8px 10px;border-radius:8px;border:1px solid #ddd;min-width:180px;
    }
    body.dark input[type="text"], body.dark input[type="number"], body.dark select {
      background:#1b1b1b;border:1px solid #333;color:#eaeaea;
    }

    button.primary {
      background:var(--accent); color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;
    }
    button.ghost {
      background:transparent;border:1px solid #ccc;padding:7px 10px;border-radius:8px;color:inherit;cursor:pointer;
    }

    /* small actions row (expand/export) */
    .actions-row { display:flex; gap:8px; margin:10px 0 18px 0; align-items:center; }

    /* Results area */
    #resultado { margin-top:18px; }

    /* Team card */
    .team-card {
      border-radius:10px;
      overflow:hidden;
      margin-bottom:12px;
      background:var(--card-bg);
      color:var(--card-text);
      border:1px solid rgba(0,0,0,0.06);
    }
    body.dark .team-card { background:#111; border:1px solid rgba(255,255,255,0.03); }

    .team-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      cursor:pointer;
    }
    .team-header .left { display:flex; gap:12px; align-items:center; }
    .team-title { font-weight:700; }
    .team-meta { color:var(--muted); font-size:13px; }

    .team-badges { display:flex; gap:8px; align-items:center; }
    .team-badge {
      background:var(--accent);
      color:#fff;
      padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700;
    }
    .team-badge.franchise { background:#1976d2; }
    .team-badge.inj { background:#d32f2f; }
    body.dark .team-badge.inj { background:#ef5350; }

    .team-body { padding:12px 14px; border-top:1px solid rgba(0,0,0,0.04); display:none; }
    body.dark .team-body { border-top:1px solid rgba(255,255,255,0.03); }

    /* player card (visual) */
    .player-card {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px;
      border-radius:8px;
      margin:8px 0;
      box-shadow:0 6px 14px rgba(0,0,0,0.06);
      background: #fafafa;
    }
    body.dark .player-card { box-shadow:none; background:#151515; }

    .player-left { display:flex; gap:12px; align-items:center; }
    .player-name { font-weight:700; }
    .player-pos { color:var(--muted); font-size:13px; }

    .status-pill {
      padding:6px 10px;border-radius:999px;color:#fff;font-weight:700;font-size:13px;
    }
    .status-Out { background:#b71c1c; }
    .status-Questionable, .status-Doubtful { background:var(--orange); }
    .status-IR { background:#6a1b9a; }
    .status-Suspended { background:#424242; }
    .status-Healthy { background:#2e7d32; color:#fff; }

    .players-list .group-title { margin-top:10px; font-weight:700; }

    /* empty slot alert (novo) */
    .empty-alert {
      color: var(--bad);
      font-weight: 800;
      margin-bottom: 8px;
    }

    /* summary */
    .summary { margin-top:8px;font-weight:700; }

    /* footer fixed-ish at page bottom area */
    footer {
      position:fixed;
      left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.98);
      color:#333;
      padding:10px 18px;
      box-shadow:0 -6px 30px rgba(0,0,0,0.08);
      display:flex;
      justify-content:center;
      gap:18px;
      align-items:center;
      font-size:14px;
    }
    body.dark footer {
      background:rgba(10,10,10,0.98);
      color:#ddd;
    }
    footer a { color:var(--accent); text-decoration:none; font-weight:700; }
    footer a:hover { text-decoration:underline; }
    @media (max-width:900px){
      .page{margin:20px;}
      footer{font-size:13px;padding:10px;}
    }
  </style>
</head>
<body>
  <button class="dark-toggle" id="darkToggle">üåô Dark Mode</button>

  <div class="page">
    <header>
      <div class="brand">
        <div>
          <h1>Awaken</h1>
          <div style="color:var(--muted);font-size:13px">Revisando jogadores lesionados e ligas com regras de franchise players.</div>
        </div>
      </div>
    </header>

    <div class="controls">
      <!-- Panel 1: League ID -->
      <div class="panel">
        <h3>1) Buscar por League ID</h3>
        <div class="row">
          <input id="leagueId" type="text" placeholder="League ID (Ex: 1234...)" />
          <button class="primary" onclick="buscarPorLiga()">Buscar Liga</button>
        </div>
        <div style="color:var(--muted);font-size:13px;margin-top:8px;">
          Exibe titulares que n√£o est√£o 'Healthy' por time, com contador.
        </div>
      </div>

      <!-- Panel 2: Usuario -->
      <div class="panel">
        <h3>2) Buscar por Usu√°rio (username do Sleeper)</h3>
        <div class="row">
          <input id="username" type="text" placeholder="Usu√°rio Sleeper (ex: thiagomoura)" />
          <button class="primary" onclick="buscarPorUsuario()">Buscar Usu√°rio</button>
        </div>
        <div style="color:var(--muted);font-size:13px;margin-top:8px;">
          Busca em todas as ligas NFL em que o usu√°rio participa (s√≥ fantasy football).
        </div>
      </div>

      <!-- Panel 3: Franchise Players -->
      <div class="panel">
        <h3>3) Verificar Franchise Players (League ID + m√≠nimo)</h3>
        <div class="row">
          <input id="franchiseLeagueId" type="text" placeholder="League ID (Ex: 1234...)" />
          <input id="minFranchise" type="number" placeholder="M√≠nimo de titulares ‚â•" style="width:140px;" />
          <button class="primary" onclick="buscarFranchisePlayers()">Verificar Franquias</button>
        </div>
        <div style="color:var(--muted);font-size:13px;margin-top:8px;">
          Para cada time da liga mostra titulares, quantos pertencem √† franquia e compara os saud√°veis com o m√≠nimo.
        </div>
      </div>
    </div>

    <!-- Actions (appear after franchise search) -->
    <div class="actions-row" id="franchiseActions" style="display:none;">
      <button class="ghost" id="expandAllBtn">Expandir todos</button>
      <button class="ghost" id="collapseAllBtn">Recolher todos</button>
      <button class="primary" id="exportBtn">Exportar para WhatsApp</button>
    </div>

    <!-- Results -->
    <div id="resultado"></div>
  </div>

  <footer>
    <div id="accessCount">GMs em a√ß√£o: 0</div>
    <div><a href="mailto:scrum.moura@gmail.com">Algo errado? Novas ideias? Manda pra c√°.</a></div>
  </footer>

<script>
/* --------------------------
   Data: 32 teams + abbr map
   -------------------------- */
const nflTeams = [
  "Arizona Cardinals","Atlanta Falcons","Baltimore Ravens","Buffalo Bills",
  "Carolina Panthers","Chicago Bears","Cincinnati Bengals","Cleveland Browns",
  "Dallas Cowboys","Denver Broncos","Detroit Lions","Green Bay Packers",
  "Houston Texans","Indianapolis Colts","Jacksonville Jaguars","Kansas City Chiefs",
  "Las Vegas Raiders","Los Angeles Chargers","Los Angeles Rams","Miami Dolphins",
  "Minnesota Vikings","New England Patriots","New Orleans Saints","New York Giants",
  "New York Jets","Philadelphia Eagles","Pittsburgh Steelers","San Francisco 49ers",
  "Seattle Seahawks","Tampa Bay Buccaneers","Tennessee Titans","Washington Commanders"
];

const abbrToFull = {
  ARI: "Arizona Cardinals", ATL: "Atlanta Falcons", BAL: "Baltimore Ravens", BUF: "Buffalo Bills",
  CAR: "Carolina Panthers", CHI: "Chicago Bears", CIN: "Cincinnati Bengals", CLE: "Cleveland Browns",
  DAL: "Dallas Cowboys", DEN: "Denver Broncos", DET: "Detroit Lions", GB: "Green Bay Packers",
  HOU: "Houston Texans", IND: "Indianapolis Colts", JAX: "Jacksonville Jaguars", KC: "Kansas City Chiefs",
  LV: "Las Vegas Raiders", LAC: "Los Angeles Chargers", LAR: "Los Angeles Rams", MIA: "Miami Dolphins",
  MIN: "Minnesota Vikings", NE: "New England Patriots", NO: "New Orleans Saints", NYG: "New York Giants",
  NYJ: "New York Jets", PHI: "Philadelphia Eagles", PIT: "Pittsburgh Steelers", SF: "San Francisco 49ers",
  SEA: "Seattle Seahawks", TB: "Tampa Bay Buccaneers", TEN: "Tennessee Titans", WSH: "Washington Commanders",
  WAS: "Washington Commanders"
};

// normalize helpers
function normalizeName(s){
  if(!s) return "";
  return String(s).toLowerCase().replace(/[^a-z0-9]/g,"");
}
function matchTeamByName(name){
  if(!name) return "";
  const n = normalizeName(name);
  for(const t of nflTeams){
    if(normalizeName(t).includes(n) || n.includes(normalizeName(t))) return t;
  }
  const parts = name.split(/\s+/).map(p => normalizeName(p)).filter(Boolean);
  for(const t of nflTeams){
    const tn = normalizeName(t);
    let matched = parts.every(p => tn.includes(p) || p.includes(tn));
    if(matched) return t;
  }
  return "";
}
function abbrToFullName(abbr){
  if(!abbr) return "";
  const up = String(abbr).toUpperCase();
  return abbrToFull[up] || "";
}

/* UI helpers */
const resultado = document.getElementById("resultado");
function toggleTeamBody(el){
  const body = el.querySelector(".team-body");
  if(!body) return;
  const isOpen = body.style.display === "block";
  body.style.display = isOpen ? "none" : "block";
}

/* Dark */
document.getElementById("darkToggle").addEventListener("click", () => {
  document.body.classList.toggle("dark");
  document.getElementById("darkToggle").textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
});

/* Access counter */
(function accessCounter(){
  let n = Number(localStorage.getItem("acessosSleeper") || 0);
  n++;
  localStorage.setItem("acessosSleeper", n);
  document.getElementById("accessCount").textContent = `GMs em a√ß√£o: ${n}`;
})();

/* status class helper */
function statusClass(status){
  if(!status) return "status-Healthy";
  if(status === "Out") return "status-Out";
  if(status === "Questionable" || status === "Doubtful") return "status-Questionable";
  if(status === "IR") return "status-IR";
  if(status === "Suspended") return "status-Suspended";
  return "status-Healthy";
}
function getColorForStatus(status){
  switch(status){
    case "Out": return "#b71c1c";
    case "Questionable": case "Doubtful": return "#ef6c00";
    case "IR": return "#6a1b9a";
    case "Suspended": return "#424242";
    default: return "#2e7d32";
  }
}

/* safe fetch */
async function safeFetchJson(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return await res.json();
}

/* --------------------------
   1) Buscar por League ID
   -------------------------- */
async function buscarPorLiga(){
  const leagueId = document.getElementById("leagueId").value.trim();
  document.getElementById("franchiseActions").style.display = "none";
  resultado.innerHTML = `<div class="panel">Buscando liga ${leagueId}...</div>`;
  if(!leagueId){ resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Informe um League ID.</div>`; return; }

  try{
    const [users, rosters, playersObj] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/users`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/rosters`),
      safeFetchJson(`https://api.sleeper.app/v1/players/nfl`)
    ]);
    const players = playersObj;

    const userMap = {};
    (users || []).forEach(u => {
      userMap[u.user_id] = {
        name: u.display_name || "Time sem dono",
        teamMeta: u.metadata?.team_name || ""
      };
    });

    resultado.innerHTML = "";
    for(const r of (rosters || [])){
      const owner = userMap[r.owner_id] || {name:"Time sem dono", teamMeta:""};
      const teamNameRaw = r.metadata?.team_name || owner.teamMeta || owner.name || "Sem nome definido";
      const detected = matchTeamByName(teamNameRaw) || teamNameRaw;

      const rawStarters = r.starters || [];
      // count empty starter positions (null/undefined or player missing)
      let emptyCount = 0;
      for(let i=0;i<rawStarters.length;i++){
        const id = rawStarters[i];
        if(!id || !players[id]) emptyCount++;
      }

      const starters = rawStarters; // use raw array for iteration
      const injuredPlayers = [];
      for(const pid of starters){
        const p = players[pid];
        if(!p) continue;
        if(p.injury_status && p.injury_status !== "Healthy"){
          injuredPlayers.push(p);
        }
      }

      const card = document.createElement("div"); card.className = "team-card";
      const header = document.createElement("div"); header.className = "team-header";
      header.innerHTML = `
        <div class="left">
          <div>
            <div class="team-title">${detected} ‚Äî ${owner.name}</div>
            <div class="team-meta">${teamNameRaw ? `meta: ${teamNameRaw}` : 'sem metadata'}</div>
          </div>
        </div>
        <div class="team-badges right">
          <div class="team-badge inj">${injuredPlayers.length}</div>
        </div>
      `;
      header.addEventListener("click", ()=>toggleTeamBody(card));

      const body = document.createElement("div"); body.className = "team-body";

      // empty positions alert (aparece antes da lista de jogadores)
      if(emptyCount > 0){
        const posText = emptyCount === 1 ? 'Posi√ß√£o' : 'Posi√ß√µes';
        const alertDiv = document.createElement("div");
        alertDiv.className = "empty-alert";
        alertDiv.textContent = `Alerta de ${emptyCount} ${posText} sem Jogador escalado.`;
        body.appendChild(alertDiv);
      }

      if(injuredPlayers.length === 0){
        const s = document.createElement("div"); s.className = "summary"; s.textContent = "Nenhum titular lesionado.";
        body.appendChild(s);
      } else {
        // auto open
        body.style.display = "block";
        for(const p of injuredPlayers){
          const pl = document.createElement("div"); pl.className = "player-card";
          pl.innerHTML = `
            <div class="player-left">
              <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
              <div>
                <div class="player-name">${p.full_name}</div>
                <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || "FA"}</div>
              </div>
            </div>
            <div>
              <div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status || "Healthy"}</div>
            </div>
          `;
          body.appendChild(pl);
        }
      }

      card.appendChild(header); card.appendChild(body);
      resultado.appendChild(card);
    }

  } catch(err){
    console.error(err);
    resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Erro ao buscar dados da liga. Verifique o League ID.</div>`;
  }
}

/* --------------------------
   2) Buscar por Usu√°rio
   -------------------------- */
async function buscarPorUsuario(){
  const username = document.getElementById("username").value.trim();
  document.getElementById("franchiseActions").style.display = "none";
  resultado.innerHTML = `<div class="panel">Buscando usu√°rio ${username}...</div>`;
  if(!username){ resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Informe um nome de usu√°rio.</div>`; return; }

  try{
    const userData = await safeFetchJson(`https://api.sleeper.app/v1/user/${username}`);
    if(!userData || !userData.user_id){ resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Usu√°rio n√£o encontrado.</div>`; return; }

    const [leagues, playersObj] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/user/${userData.user_id}/leagues/nfl/${new Date().getFullYear()}`),
      safeFetchJson("https://api.sleeper.app/v1/players/nfl")
    ]);
    const players = playersObj;
    resultado.innerHTML = "";

    const fantasyLeagues = (leagues || []).filter(l => l.settings && l.settings.type === 2);

    for(const league of fantasyLeagues){
      try{
        const rosters = await safeFetchJson(`https://api.sleeper.app/v1/league/${league.league_id}/rosters`);
        const roster = (rosters||[]).find(r => r.owner_id === userData.user_id);
        if(!roster) continue;

        const teamNameRaw = roster.metadata?.team_name || league.name || "";
        const detected = matchTeamByName(teamNameRaw) || teamNameRaw || league.name;

        const rawStarters = roster.starters || [];
        let emptyCount = 0;
        for(let i=0;i<rawStarters.length;i++){
          const id = rawStarters[i];
          if(!id || !players[id]) emptyCount++;
        }

        const starters = roster.starters || [];
        const injured = [];
        for(const pid of starters){
          const p = players[pid];
          if(!p) continue;
          if(p.injury_status && p.injury_status !== "Healthy") injured.push(p);
        }

        const card = document.createElement("div"); card.className = "team-card";
        const header = document.createElement("div"); header.className = "team-header";
        header.innerHTML = `
          <div class="left">
            <div>
              <div class="team-title">${detected} ‚Äî Liga ID: ${league.league_id}</div>
              <div class="team-meta">Liga: ${league.name}</div>
            </div>
          </div>
          <div class="team-badges right">
            <div class="team-badge inj">${injured.length}</div>
          </div>
        `;
        header.addEventListener("click", ()=>toggleTeamBody(card));

        const body = document.createElement("div"); body.className = "team-body";

        // empty positions alert
        if(emptyCount > 0){
          const posText = emptyCount === 1 ? 'Posi√ß√£o' : 'Posi√ß√µes';
          const alertDiv = document.createElement("div");
          alertDiv.className = "empty-alert";
          alertDiv.textContent = `Alerta de ${emptyCount} ${posText} sem Jogador escalado.`;
          body.appendChild(alertDiv);
        }

        if(injured.length === 0){
          const s = document.createElement("div"); s.className = "summary"; s.textContent = "Nenhum titular lesionado encontrado nesta liga.";
          body.appendChild(s);
        } else {
          body.style.display = "block";
          for(const p of injured){
            const pl = document.createElement("div"); pl.className = "player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || "FA"}</div>
                </div>
              </div>
              <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status}</div></div>
            `;
            body.appendChild(pl);
          }
        }

        card.appendChild(header); card.appendChild(body);
        resultado.appendChild(card);

      } catch(errInner){
        console.warn("Erro ao processar liga", league.league_id, errInner);
      }
    }

  } catch(err){
    console.error(err);
    resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Erro ao buscar usu√°rio.</div>`;
  }
}

/* --------------------------
   3) Buscar Franchise Players
   -------------------------- */
async function buscarFranchisePlayers(){
  const leagueId = document.getElementById("franchiseLeagueId").value.trim();
  const minFranchiseRaw = document.getElementById("minFranchise").value.trim();
  const minFranchise = parseInt(minFranchiseRaw || "0", 10);
  resultado.innerHTML = `<div class="panel">Buscando franquias na liga ${leagueId}...</div>`;
  if(!leagueId || !minFranchiseRaw){ resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Informe League ID e n√∫mero m√≠nimo.</div>`; return; }

  try {
    const [users, rosters, playersObj] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/users`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/rosters`),
      safeFetchJson("https://api.sleeper.app/v1/players/nfl")
    ]);
    const players = playersObj;
    const userMap = {};
    (users||[]).forEach(u => {
      userMap[u.user_id] = {
        name: u.display_name || "Time sem dono",
        userTeamMeta: u.metadata?.team_name || ""
      };
    });

    // Build enriched list with precomputed franchise detection & counts (and empty starter count)
    const enriched = (rosters || []).map(r => {
      const owner = userMap[r.owner_id] || {name:"Time sem dono", userTeamMeta:""};
      const rawMeta = r.metadata?.team_name || owner.userTeamMeta || owner.name || "";
      // try to detect canonical name
      let detected = matchTeamByName(rawMeta);
      // raw starters array (may contain nulls)
      const rawStarters = r.starters || [];
      // starters as player objects (present only)
      const startersObjs = rawStarters.map(id => players[id]).filter(Boolean);
      // attempt inference by majority team abbr if no detected
      if(!detected){
        const counts = {};
        for(const p of startersObjs){
          if(!p || !p.team) continue;
          counts[p.team] = (counts[p.team] || 0) + 1;
        }
        let bestAbbr = "", bestCount = 0;
        for(const k in counts){ if(counts[k] > bestCount){ bestAbbr = k; bestCount = counts[k]; } }
        if(bestAbbr){
          const full = abbrToFullName(bestAbbr) || bestAbbr;
          detected = full;
        }
      }
      if(!detected) detected = rawMeta || owner.name || "Franquia sem nome";

      // compute franchiseStarters (matching p.team -> full name matching detected)
      const franchiseStarters = [];
      for(const p of startersObjs){
        const pFull = abbrToFullName(p.team) || p.team || "";
        if(normalizeName(pFull) === normalizeName(detected) || normalizeName(pFull).includes(normalizeName(detected)) || normalizeName(detected).includes(normalizeName(pFull))){
          franchiseStarters.push(p);
        }
      }
      const healthyFranchise = franchiseStarters.filter(p=>!p.injury_status || p.injury_status === "Healthy").length;
      const franchiseCount = franchiseStarters.length;
      const injuredOverall = startersObjs.filter(p => p.injury_status && p.injury_status !== "Healthy").length;

      // empty starters count (rawStarters that are null/undefined OR id not found in players)
      let emptyStartersCount = 0;
      for(let i=0;i<rawStarters.length;i++){
        const id = rawStarters[i];
        if(!id || !players[id]) emptyStartersCount++;
      }

      return {
        roster: r,
        owner,
        rawMeta,
        detected,
        rawStarters,
        starters: startersObjs,
        franchiseStarters,
        franchiseCount,
        healthyFranchise,
        injuredOverall,
        emptyStartersCount
      };
    });

    // Sort by detected (franchise name)
    enriched.sort((a,b) => (a.detected || "").localeCompare(b.detected || ""));

    // render
    resultado.innerHTML = "";
    // show actions
    const actions = document.getElementById("franchiseActions");
    if(actions) actions.style.display = "flex";

    for(const en of enriched){
      const r = en.roster;
      const owner = en.owner;
      const franchiseName = en.detected;
      const starters = en.starters;
      // precomputed counts
      const franchiseCount = en.franchiseCount;
      const injuredOverall = en.injuredOverall;
      const healthyFranchise = en.healthyFranchise;
      const emptyCount = en.emptyStartersCount;

      // create card
      const card = document.createElement("div"); card.className = "team-card";
      // header: show franchise name and owner, badges for franchiseCount and injuredOverall
      const header = document.createElement("div"); header.className = "team-header";
      header.innerHTML = `
        <div class="left">
          <div>
            <div class="team-title">${franchiseName} ‚Äî ${owner.name}</div>
            <div class="team-meta">${en.rawMeta ? `meta: ${en.rawMeta}` : ''}</div>
          </div>
        </div>
        <div class="team-badges right">
          <div class="team-badge franchise" data-franchise-count>${franchiseCount}</div>
          <div class="team-badge inj" data-injured-count>${injuredOverall}</div>
        </div>
      `;
      header.addEventListener("click", ()=>toggleTeamBody(card));

      const body = document.createElement("div"); body.className = "team-body";

      // editable franchise input
      const franchiseRow = document.createElement("div");
      franchiseRow.style.marginBottom = "8px";
      franchiseRow.innerHTML = `
        <label style="font-weight:700;margin-right:8px;">Nome da Franquia (edite se necess√°rio):</label>
        <input type="text" class="team-input" value="${franchiseName}" style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;width:60%;" />
      `;
      body.appendChild(franchiseRow);

      // container for players lists and summary
      const containerPlayers = document.createElement("div");
      containerPlayers.className = "players-list";
      body.appendChild(containerPlayers);

      // recompute function uses current input to recalc and update header badges & lists
      function recompute(){
        // clear container
        containerPlayers.innerHTML = "";

        // current input value
        const franchiseVal = (franchiseRow.querySelector(".team-input").value || "").trim();
        let franchiseFull = franchiseVal;
        if(franchiseVal && franchiseVal.length <= 3){
          const mapped = abbrToFullName(franchiseVal.toUpperCase());
          if(mapped) franchiseFull = mapped;
        } else {
          const matched = matchTeamByName(franchiseVal);
          if(matched) franchiseFull = matched;
        }
        if(!franchiseFull) franchiseFull = franchiseName; // fallback to detected

        // compute franchiseStarters based on current franchiseFull
        const franchiseStartersNow = [];
        for(const p of starters){
          const pFull = abbrToFullName(p.team) || p.team || "";
          if(normalizeName(pFull) === normalizeName(franchiseFull) || normalizeName(pFull).includes(normalizeName(franchiseFull)) || normalizeName(franchiseFull).includes(normalizeName(pFull))){
            franchiseStartersNow.push(p);
          }
        }
        const healthyFrNow = franchiseStartersNow.filter(p=>!p.injury_status || p.injury_status === "Healthy").length;
        const franchiseCountNow = franchiseStartersNow.length;

        // injured starters overall (non-healthy)
        const nonHealthyStarters = starters.filter(p => p.injury_status && p.injury_status !== "Healthy");

        // update header badges
        const frBadge = header.querySelector("[data-franchise-count]");
        const injBadge = header.querySelector("[data-injured-count]");
        if(frBadge) frBadge.textContent = franchiseCountNow;
        if(injBadge) injBadge.textContent = nonHealthyStarters.length;

        // summary
        const summary = document.createElement("div"); summary.className = "summary";
        summary.innerHTML = `Titulares da franquia identificados: <strong>${franchiseCountNow}</strong> ‚Äî Saud√°veis: <strong>${healthyFrNow}</strong> (m√≠nimo: <strong>${minFranchise}</strong>)`;
        containerPlayers.appendChild(summary);

        // status ok / risk
        const statusLine = document.createElement("div");
        statusLine.style.marginTop = "6px";
        if(healthyFrNow >= minFranchise){
          statusLine.innerHTML = `<div style="color:var(--ok);font-weight:800;margin-top:6px;">‚úÖ Bom trabalho ‚Äî franquia atende o m√≠nimo.</div>`;
        } else {
          const falta = minFranchise - healthyFrNow;
          statusLine.innerHTML = `<div style="color:var(--bad);font-weight:800;margin-top:6px;">‚ö†Ô∏è Franquia em Risco ‚Äî faltam <strong>${falta}</strong> titulares saud√°veis.</div>`;
        }
        containerPlayers.appendChild(statusLine);

        // ** ALERTA DE POSI√á√ïES VAZIAS (aparece antes da listagem) **
        if(en.emptyStartersCount && en.emptyStartersCount > 0){
          const posText = en.emptyStartersCount === 1 ? 'Posi√ß√£o' : 'Posi√ß√µes';
          const alertDiv = document.createElement("div");
          alertDiv.className = "empty-alert";
          alertDiv.textContent = `Alerta de ${en.emptyStartersCount} ${posText} sem Jogador escalado.`;
          containerPlayers.appendChild(alertDiv);
        }

        // list non-franchise injured starters (all non-healthy starters)
        if(nonHealthyStarters.length > 0){
          const title = document.createElement("div"); title.className = "group-title"; title.textContent = "Titulares com status diferente de Healthy (todos):";
          containerPlayers.appendChild(title);
          const nonList = document.createElement("div"); nonList.className = "nonhealthy-list";
          for(const p of nonHealthyStarters){
            const pl = document.createElement("div"); pl.className = "player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || ""}</div>
                </div>
              </div>
              <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status}</div></div>
            `;
            nonList.appendChild(pl);
          }
          containerPlayers.appendChild(nonList);
        } else {
          const none = document.createElement("div"); none.style.marginTop="8px"; none.textContent = "Nenhum titular com status diferente de Healthy.";
          containerPlayers.appendChild(none);
        }

        // list franchiseStartersNow (highlight)
        const frTitle = document.createElement("div"); frTitle.className = "group-title"; frTitle.textContent = "Titulares pertencentes √† franquia:";
        containerPlayers.appendChild(frTitle);
        const frList = document.createElement("div"); frList.className = "franchise-list";
        if(franchiseStartersNow.length > 0){
          for(const p of franchiseStartersNow){
            const pl = document.createElement("div"); pl.className = "player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || ""}</div>
                </div>
              </div>
              <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status || "Healthy"}</div></div>
            `;
            frList.appendChild(pl);
          }
        } else {
          const none = document.createElement("div"); none.style.marginTop="8px"; none.textContent = "Nenhum titular da franquia foi identificado entre os starters.";
          frList.appendChild(none);
        }
        containerPlayers.appendChild(frList);

        // set dataset values for export
        card.dataset.franchiseCount = franchiseCountNow;
        card.dataset.healthyFranchise = healthyFrNow;
        card.dataset.injuredOverall = nonHealthyStarters.length;

        // auto-open if there are injured or in risk
        if(nonHealthyStarters.length > 0 || healthyFrNow < minFranchise){
          body.style.display = "block";
        } else {
          body.style.display = "none";
        }
      }

      // initial render
      recompute();

      // wire input events
      const inputEl = franchiseRow.querySelector(".team-input");
      inputEl.addEventListener("change", recompute);
      inputEl.addEventListener("keyup", (e)=>{ if(e.key === "Enter") recompute(); });

      // attach header and body
      card.appendChild(header);
      card.appendChild(body);
      resultado.appendChild(card);
    }

    // wire actions
    document.getElementById("expandAllBtn").onclick = ()=> {
      document.querySelectorAll(".team-body").forEach(b=>b.style.display="block");
    };
    document.getElementById("collapseAllBtn").onclick = ()=> {
      document.querySelectorAll(".team-body").forEach(b=>b.style.display="none");
    };
    document.getElementById("exportBtn").onclick = ()=> exportFranchiseWhatsApp(minFranchise);

  } catch(err){
    console.error(err);
    resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Erro ao buscar franquias. Verifique par√¢metros e League ID.</div>`;
  }
}

/* --------------------------
   Export: monta mensagem e abre WhatsApp Web
   -------------------------- */
function exportFranchiseWhatsApp(minFranchise){
  const cards = Array.from(document.querySelectorAll(".team-card"));
  const lines = [];
  for(const card of cards){
    const input = card.querySelector(".team-input");
    if(!input) continue;
    const title = card.querySelector(".team-title")?.textContent?.trim() || "Time";
    const injured = parseInt(card.dataset.injuredOverall || "0", 10);
    const healthyFr = parseInt(card.dataset.healthyFranchise || "0", 10);
    const franchiseCount = parseInt(card.dataset.franchiseCount || "0", 10);
    if(injured > 0 || healthyFr < minFranchise){
      lines.push(`${title} ‚Äî Lesionados: ${injured} | Franchise: ${franchiseCount} | Saud√°veis da franchise: ${healthyFr}/${minFranchise}`);
      const nonHealthyEls = card.querySelectorAll(".nonhealthy-list .player-card");
      if(nonHealthyEls.length){
        nonHealthyEls.forEach(el=>{
          const name = el.querySelector(".player-name")?.textContent?.trim() || "";
          const pos = el.querySelector(".player-pos")?.textContent?.trim() || "";
          const status = el.querySelector(".status-pill")?.textContent?.trim() || "";
          lines.push(`  - ${name} ${pos} ‚Äî ${status}`);
        });
      } else {
        lines.push("  - Nenhum titular lesionado listado.");
      }
      lines.push("");
    }
  }

  if(lines.length === 0){
    alert("Nenhum time em problema encontrado para exportar.");
    return;
  }

  const message = "Resumo - Times com problemas (Sleeper):\n\n" + lines.join("\n");
  navigator.clipboard.writeText(message).then(()=>{
    const open = confirm("Resumo copiado para √°rea de transfer√™ncia. Deseja abrir o WhatsApp Web com a mensagem preenchida?");
    if(open){
      const url = "https://web.whatsapp.com/send?text=" + encodeURIComponent(message);
      window.open(url, "_blank");
    } else {
      alert("Resumo copiado. Cole no WhatsApp ou onde preferir.");
    }
  }).catch(err=>{
    console.error(err);
    alert("N√£o foi poss√≠vel copiar automaticamente. Aqui est√° o resumo:\n\n" + message);
  });
}
</script>
</body>
</html>
